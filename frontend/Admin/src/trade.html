@@include("partials/main.html")

<head>

    @@include("partials/title-meta.html", {"title": "Trading Chart"})

    @@include("partials/head-css.html")

</head>

@@include("partials/body.html")
    <!-- Begin page -->
    <div id="layout-wrapper" class="sidebar-enable vertical-collpsed">

        @@include("partials/menu.html")

        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <div class="row">
                        <div class="col-12">

                            <div class="row">
                                <!-- Contenedor de los botones de lotaje, compra y venta -->
                                <div class="col-lg-12">
                                    <div id="lot-size-buttons-container" class="d-flex justify-content-center align-items-center mb-4" style="position: relative;">
                                        <!-- Selector de lotaje -->
                                        <div class="lot-size-selector me-4">
                                            <div class="d-flex align-items-center">
                                                <!-- Flechas para modificar la parte entera del lotaje -->
                                                <button class="btn btn-light btn-lg lot-control" id="decrease-lot-whole">-</button>
                                                <input type="number" id="lot-size" class="form-control form-control-lg text-center mx-2" value="1.00" step="0.01" min="0.01">
                                                <button class="btn btn-light btn-lg lot-control" id="increase-lot-whole">+</button>
                                            </div>
                                        </div>

                                        <!-- Botones de compra y venta -->
                                        <button id="buy-button" class="btn-modern btn-lg me-3">Buy <span id="buy-price" class="price-label">0</span></button>
                                        <button id="sell-button" class="btn-modern btn-lg">Sell <span id="sell-price" class="price-label">0</span></button>
                                    </div>
                                </div>

                                <!-- Contenedor del gráfico -->
                                <div class="col-lg-12">
                                    <div class="card" id="chart-card" style="position: relative;">
                                        <div class="card-body">
                                            <div id="chart-container" style="height: 500px; margin-top: 20px;"></div>
                                        </div>
                                    </div>
                                </div> <!-- end col -->

                            </div>

                            <div style='clear:both'></div>

                        </div>
                    </div>

                </div> <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

            @@include("partials/footer.html")
        </div>
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->

    @@include("partials/right-sidebar.html")

    @@include("partials/vendor-script.html")

    <!-- Inicializa el gráfico de lightweight-charts -->
    <script src="../../charts/node_modules/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <script>
        let lastPrice = null;

        const buyButton = document.getElementById('buy-button');
        const sellButton = document.getElementById('sell-button');
        const chartContainer = document.getElementById('chart-container');
        const lotSizeButtonsContainer = document.getElementById('lot-size-buttons-container');
        const buyPriceSpan = document.getElementById('buy-price');
        const sellPriceSpan = document.getElementById('sell-price');
        const lotSizeInput = document.getElementById('lot-size');

        // Funciones para controlar el lotaje
        const increaseLotWhole = document.getElementById('increase-lot-whole');
        const decreaseLotWhole = document.getElementById('decrease-lot-whole');

        // Actualiza el tamaño del lotaje
        const updateLotSize = (changeWhole, changeDecimal) => {
            let currentLotSize = parseFloat(lotSizeInput.value);

            if (changeWhole !== 0) {
                currentLotSize = Math.max(0.01, currentLotSize + changeWhole);
            }

            if (changeDecimal !== 0) {
                let decimalPart = (currentLotSize * 100) % 100;
                decimalPart = Math.min(99, Math.max(0, decimalPart + changeDecimal));
                currentLotSize = Math.floor(currentLotSize) + decimalPart / 100;
            }

            lotSizeInput.value = currentLotSize.toFixed(2);
        };

        // Eventos para aumentar/disminuir la parte entera del lotaje
        increaseLotWhole.addEventListener('click', () => updateLotSize(1, 0));
        decreaseLotWhole.addEventListener('click', () => updateLotSize(-1, 0));

        // Permitir el ingreso manual del lotaje
        lotSizeInput.addEventListener('input', (event) => {
            let newValue = parseFloat(event.target.value);
            if (isNaN(newValue) || newValue < 0.01) {
                lotSizeInput.value = '0.01';
            }
        });

        // Controlar los decimales con las flechas en el input de lotaje
        lotSizeInput.addEventListener('wheel', function(event) {
            if (event.deltaY < 0) {
                updateLotSize(0, 1); // Rueda hacia arriba, aumenta decimales
            } else {
                updateLotSize(0, -1); // Rueda hacia abajo, disminuye decimales
            }
        });

        // Inicializa el gráfico en el div #chart-container
        const chart = LightweightCharts.createChart(chartContainer, {
            width: chartContainer.offsetWidth,
            height: 500,
            layout: {
                margin: {
                    top: 20,
                    left: 20,
                }
            },
            leftPriceScale: {
                borderVisible: false,
            },
        });

        const candleSeries = chart.addCandlestickSeries();

        // Cargar datos históricos desde la API de Binance
        const loadHistoricalData = () => {
            const apiUrl = 'https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=1000';

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const chartData = data.map(d => ({
                        time: d[0] / 1000,  // Convierte el tiempo a formato UNIX
                        open: parseFloat(d[1]),
                        high: parseFloat(d[2]),
                        low: parseFloat(d[3]),
                        close: parseFloat(d[4]),
                    }));
                    candleSeries.setData(chartData); // Cargar los datos históricos en el gráfico

                    const latestPrice = parseFloat(data[data.length - 1][4]);
                    buyPriceSpan.textContent = latestPrice.toFixed(2);
                    sellPriceSpan.textContent = latestPrice.toFixed(2);
                    lastPrice = latestPrice;

                    // Inicializa los botones con fondo blanco y texto negro (estado inicial)
                    buyButton.style.backgroundColor = 'white';
                    buyButton.style.color = 'black';
                    sellButton.style.backgroundColor = 'white';
                    sellButton.style.color = 'black';
                })
                .catch(error => console.error('Error al obtener los datos históricos:', error));
        };

        loadHistoricalData();

        // Conectar al WebSocket de Binance para actualizaciones en tiempo real de BTC/USDT
        const binanceSocket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');

        binanceSocket.onmessage = function (event) {
            const message = JSON.parse(event.data);
            const newCandle = message.k;
            const newTick = {
                time: newCandle.t / 1000,
                open: parseFloat(newCandle.o),
                high: parseFloat(newCandle.h),
                low: parseFloat(newCandle.l),
                close: parseFloat(newCandle.c),
            };
            candleSeries.update(newTick);

            const currentPrice = parseFloat(newCandle.c);
            buyPriceSpan.textContent = currentPrice.toFixed(2);
            sellPriceSpan.textContent = currentPrice.toFixed(2);

            if (lastPrice) {
                if (currentPrice > lastPrice) {
                    buyButton.style.backgroundColor = '#26A69A'; // Verde
                    buyButton.style.color = 'white'; // Texto blanco
                    sellButton.style.backgroundColor = 'white'; // Fondo blanco
                    sellButton.style.color = '#EF5350'; // Texto rojo
                } else if (currentPrice < lastPrice) {
                    buyButton.style.backgroundColor = 'white'; // Fondo blanco
                    buyButton.style.color = '#26A69A'; // Texto verde
                    sellButton.style.backgroundColor = '#EF5350'; // Rojo
                    sellButton.style.color = 'white'; // Texto blanco
                } else {
                    buyButton.style.backgroundColor = 'white'; // Fondo blanco
                    buyButton.style.color = '#26A69A'; // Texto verde
                    sellButton.style.backgroundColor = 'white'; // Fondo blanco
                    sellButton.style.color = '#EF5350'; // Texto rojo
                }
            }

            lastPrice = currentPrice;
        };

        window.addEventListener('resize', () => {
            chart.applyOptions({ width: chartContainer.offsetWidth });
        });

        // Descolapsar el sidebar cuando se hace clic en el botón de toggle del menú
        document.querySelector('.button-menu-mobile').addEventListener('click', () => {
            document.getElementById('layout-wrapper').classList.toggle('vertical-collpsed');
        });
    </script>

    <!-- Estilo para los botones modernos, control de lotaje y sombras -->
    <style>
        .btn-modern {
            font-size: 16px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            transition: background-color 0.3s ease, color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra moderna */
        }
        #buy-button, #sell-button {
            background-color: white;
            color: black;
        }
        #chart-container, #lot-size-buttons-container, #chart-card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra moderna */
        }
    </style>

    <!-- Script requerido -->
    <script src="assets/js/app.js"></script>

</body>
</html>
